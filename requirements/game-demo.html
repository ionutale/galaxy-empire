import React, { useState, useEffect, useCallback, useReducer } from 'react';

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
// MOCK DATA & CONFIGURATION
// In a real application, this would come from a server.
//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~

const BUILDING_DATA = {
  'controlCenter': { name: 'Control Center', description: 'The heart of your colony. Upgrading unlocks new buildings and expands build slots.', cost: (level) => ({ metal: 100 * Math.pow(1.8, level), crystal: 50 * Math.pow(1.8, level) }), time: (level) => 60 * Math.pow(1.5, level), benefit: (level) => `Unlocks new building options.` },
  'metalMine': { name: 'Metal Mine', description: 'Extracts and refines metal ore from the planet\'s crust.', cost: (level) => ({ metal: 60 * Math.pow(1.5, level), crystal: 15 * Math.pow(1.5, level) }), time: (level) => 45 * Math.pow(1.6, level), production: (level) => 30 * level * Math.pow(1.1, level), benefit: (level) => `Production/hr: ${formatNumber(30 * level * Math.pow(1.1, level))} -> ${formatNumber(30 * (level+1) * Math.pow(1.1, level+1))}` },
  'crystalSynthesizer': { name: 'Crystal Synthesizer', description: 'Grows valuable crystals used in advanced electronics and research.', cost: (level) => ({ metal: 48 * Math.pow(1.6, level), crystal: 24 * Math.pow(1.6, level) }), time: (level) => 50 * Math.pow(1.6, level), production: (level) => 20 * level * Math.pow(1.1, level), benefit: (level) => `Production/hr: ${formatNumber(20 * level * Math.pow(1.1, level))} -> ${formatNumber(20 * (level+1) * Math.pow(1.1, level+1))}` },
  'deuteriumRefinery': { name: 'Deuterium Refinery', description: 'Synthesizes Deuterium, the fuel for your fleets.', cost: (level) => ({ metal: 225 * Math.pow(1.5, level), crystal: 75 * Math.pow(1.5, level) }), time: (level) => 120 * Math.pow(1.7, level), production: (level) => 10 * level * Math.pow(1.1, level), benefit: (level) => `Production/hr: ${formatNumber(10 * level * Math.pow(1.1, level))} -> ${formatNumber(10 * (level+1) * Math.pow(1.1, level+1))}` },
  'shipyard': { name: 'Shipyard', description: 'Constructs your fleets and defensive structures.', cost: (level) => ({ metal: 400 * Math.pow(2, level), crystal: 200 * Math.pow(2, level) }), time: (level) => 300 * Math.pow(1.8, level), requires: { building: 'controlCenter', level: 2 }, benefit: (level) => `Reduces ship construction time.` },
  'researchLab': { name: 'Research Lab', description: 'Unlocks powerful new technologies for your empire.', cost: (level) => ({ metal: 200 * Math.pow(2, level), crystal: 400 * Math.pow(2, level) }), time: (level) => 300 * Math.pow(1.8, level), requires: { building: 'controlCenter', level: 1 }, benefit: (level) => `Reduces research time.` },
  'terraformer': { name: 'Terraformer', description: 'Improves planet habitability and increases maximum population/production.', cost: (level) => ({ metal: 1000 * Math.pow(1.9, level), crystal: 800 * Math.pow(1.9, level) }), time: (level) => 600 * Math.pow(1.7, level), requires: { building: 'controlCenter', level: 3 }, benefit: (level) => `Increases base production by ${Math.floor(5 * level)}%` },
  'naniteFactory': { name: 'Nanite Factory', description: 'Speeds up construction and repairs using nanotechnology.', cost: (level) => ({ metal: 1500 * Math.pow(2, level), crystal: 1200 * Math.pow(2, level) }), time: (level) => 900 * Math.pow(1.8, level), requires: { building: 'shipyard', level: 2 }, benefit: (level) => `Reduces build times by ${Math.min(50, 5 * level)}%` },
  'fusionReactor': { name: 'Fusion Reactor', description: 'Provides large amounts of energy to power advanced systems.', cost: (level) => ({ metal: 800 * Math.pow(1.8, level), crystal: 600 * Math.pow(1.8, level), deuterium: 200 * Math.pow(1.6, level) }), time: (level) => 700 * Math.pow(1.7, level), benefit: (level) => `Increases energy cap and improves efficiency.` },
  'missileSilo': { name: 'Missile Silo', description: 'Houses defensive missiles to protect your colonies.', cost: (level) => ({ metal: 500 * Math.pow(1.6, level), crystal: 300 * Math.pow(1.6, level) }), time: (level) => 400 * Math.pow(1.6, level), requires: { building: 'controlCenter', level: 2 }, benefit: (level) => `Adds anti-ship defensive capability.` },
  'sensorPhalanx': { name: 'Sensor Phalanx', description: 'Long-range sensors that reveal fleet movements and cloaked targets.', cost: (level) => ({ metal: 600 * Math.pow(1.7, level), crystal: 600 * Math.pow(1.7, level) }), time: (level) => 450 * Math.pow(1.6, level), requires: { research: 'laserTechnology', level: 1 }, benefit: (level) => `Increases detection range and intel accuracy.` },
  );
}

  'cruiser': { name: 'Cruiser', cost: { metal: 20000, crystal: 7000 }, attack: 400, defense: 150, speed: 10000, time: 90, requires: { research: 'impulseDrive', level: 2 } },
  'battleship': { name: 'Battleship', cost: { metal: 45000, crystal: 15000 }, attack: 1000, defense: 500, speed: 7500, time: 240, requires: { research: 'hyperspaceDrive', level: 4 } },
  'colonyShip': { name: 'Colony Ship', cost: { metal: 10000, crystal: 20000, deuterium: 10000 }, attack: 0, defense: 100, speed: 2500, time: 300, requires: { research: 'impulseDrive', level: 3 } },
};

const RESEARCH_DATA = {
    'energyTechnology': { name: 'Energy Technology', description: 'Improves energy production efficiency.', cost: (level) => ({ crystal: 800 * Math.pow(2, level), deuterium: 400 * Math.pow(2, level) }), time: (level) => 600 * Math.pow(1.8, level), requires: { building: 'researchLab', level: 1 } },
    'combustionDrive': { name: 'Combustion Drive', description: 'Basic propulsion for light ships.', cost: (level) => ({ metal: 400 * Math.pow(2, level), deuterium: 600 * Math.pow(2, level) }), time: (level) => 900 * Math.pow(1.8, level), requires: { research: 'energyTechnology', level: 1 } },
    'impulseDrive': { name: 'Impulse Drive', description: 'Advanced propulsion for medium ships.', cost: (level) => ({ metal: 2000 * Math.pow(2, level), deuterium: 4000 * Math.pow(2, level) }), time: (level) => 1800 * Math.pow(1.8, level), requires: { research: 'combustionDrive', level: 3 } },
    'hyperspaceDrive': { name: 'Hyperspace Drive', description: 'Top-tier propulsion for capital ships.', cost: (level) => ({ metal: 10000 * Math.pow(2, level), deuterium: 20000 * Math.pow(2, level) }), time: (level) => 3600 * Math.pow(1.8, level), requires: { research: 'impulseDrive', level: 5 } },
    'laserTechnology': { name: 'Laser Technology', description: 'Unlocks basic laser weaponry.', cost: (level) => ({ metal: 200 * Math.pow(2, level), crystal: 100 * Math.pow(2, level) }), time: (level) => 750 * Math.pow(1.8, level), requires: { research: 'energyTechnology', level: 2 } },
    'armorTechnology': { name: 'Armor Technology', description: 'Increases structural integrity of all units by 10% per level.', cost: (level) => ({ metal: 1000 * Math.pow(2, level) }), time: (level) => 1200 * Math.pow(1.8, level), requires: { building: 'researchLab', level: 2 } },
};

// Additional game collectibles / modules ("chips") used to augment ships or empire-wide stats
const CHIP_DATA = {
  'attackChip': { name: 'Attack Chip', description: 'Increases ship attack by 10% per level.', cost: (level) => ({ crystal: 500 * Math.pow(1.7, level), deuterium: 200 * Math.pow(1.6, level) }), time: (level) => 300 * Math.pow(1.6, level), effect: (level) => `+${10 * level}% attack` },
  'defenseChip': { name: 'Defense Chip', description: 'Increases ship defense by 10% per level.', cost: (level) => ({ metal: 400 * Math.pow(1.7, level), crystal: 400 * Math.pow(1.7, level) }), time: (level) => 300 * Math.pow(1.6, level), effect: (level) => `+${10 * level}% defense` },
  'speedChip': { name: 'Speed Chip', description: 'Improves ship travel speed (reduces travel time).', cost: (level) => ({ crystal: 600 * Math.pow(1.6, level), deuterium: 300 * Math.pow(1.5, level) }), time: (level) => 400 * Math.pow(1.5, level), effect: (level) => `-${5 * level}% travel time` },
  'cargoChip': { name: 'Cargo Chip', description: 'Increases cargo hold efficiency for fleets.', cost: (level) => ({ metal: 300 * Math.pow(1.5, level), crystal: 500 * Math.pow(1.5, level) }), time: (level) => 350 * Math.pow(1.5, level), effect: (level) => `+${10 * level}% cargo` },
};

// Systems represent meta-game systems/features that can be unlocked or interacted with
const SYSTEMS_DATA = {
  'trade': { name: 'Trade System', description: 'Enables resource trading, market orders, and price discovery.', requires: { building: 'controlCenter', level: 1 } },
  'espionage': { name: 'Espionage', description: 'Spy on other players, steal limited intel and sabotage operations.', requires: { research: 'energyTechnology', level: 1 } },
  'diplomacy': { name: 'Diplomacy', description: 'Formalize alliances, treaties and war declarations.', requires: { building: 'controlCenter', level: 1 } },
  'automation': { name: 'Automation', description: 'Enable automation scripts: auto-build, auto-research and simple macros.', requires: { building: 'controlCenter', level: 3 } },
};

// This is now mutable for colonization simulation
let GALAXY_DATA = Array.from({ length: 9 }, (_, i) => ({
  id: i + 1,
  systems: Array.from({ length: 499 }, (_, j) => {
    const hasPlayer = Math.random() > 0.95;
    const defensePower = hasPlayer ? Math.floor(Math.random() * 50000) : 0;
    return {
      id: j + 1,
      player: hasPlayer ? `Player${Math.floor(Math.random() * 10000)}` : null,
      planets: hasPlayer ? Math.floor(Math.random() * 5) + 1 : 0,
      isHostile: Math.random() > 0.9,
      defense: defensePower,
    };
  }),
}));
GALAXY_DATA[0].systems[0].player = 'Player1'; // Ensure home system is owned.

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
// UTILITY & HELPER FUNCTIONS
//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~

const formatNumber = (num) => {
  if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return Math.floor(num).toString();
};

const formatTime = (seconds) => {
  if (seconds <= 0) return '00:00:00';
  const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
  const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
  const s = Math.floor(seconds % 60).toString().padStart(2, '0');
  return `${h}:${m}:${s}`;
};

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
// GAME STATE MANAGEMENT (useReducer)
//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~

const initialPlanetState = {
    id: 1,
    name: "Homeworld",
    coordinates: "1:1",
    resources: { metal: 500, crystal: 500, deuterium: 0 },
    buildings: { controlCenter: 1, metalMine: 1, crystalSynthesizer: 1, deuteriumRefinery: 0, shipyard: 0, researchLab: 0 },
    ships: { lightFighter: 5, cruiser: 0, battleship: 0, colonyShip: 0 },
    buildQueue: [],
    shipQueue: [],
};

const initialState = {
  planets: [initialPlanetState],
  currentPlanetId: 1,
  research: { energyTechnology: 0, combustionDrive: 0, impulseDrive: 0, hyperspaceDrive: 0, laserTechnology: 0, armorTechnology: 0 },
  researchQueue: null,
  fleetMovements: [],
  battleReports: [],
  alliance: null,
  notifications: [],
  darkMatter: 1000,
};

function gameReducer(state, action) {
  // Helper to find and update a specific planet
  const updatePlanet = (planetId, updater) => {
    return state.planets.map(p => p.id === planetId ? updater(p) : p);
  };

  switch (action.type) {
    case 'SET_CURRENT_PLANET':
        return { ...state, currentPlanetId: action.payload };
    case 'TICK': {
        const newPlanets = state.planets.map(planet => {
            const metalProd = planet.buildings.metalMine > 0 ? BUILDING_DATA.metalMine.production(planet.buildings.metalMine) / 3600 : 0;
            const crystalProd = planet.buildings.crystalSynthesizer > 0 ? BUILDING_DATA.crystalSynthesizer.production(planet.buildings.crystalSynthesizer) / 3600 : 0;
            const deuteriumProd = planet.buildings.deuteriumRefinery > 0 ? BUILDING_DATA.deuteriumRefinery.production(planet.buildings.deuteriumRefinery) / 3600 : 0;
            return {
                ...planet,
                resources: { ...planet.resources, metal: planet.resources.metal + metalProd, crystal: planet.resources.crystal + crystalProd, deuterium: planet.resources.deuterium + deuteriumProd },
                buildQueue: planet.buildQueue.map(item => ({...item, timeLeft: item.timeLeft - 1})).filter(item => item.timeLeft >= 0),
                shipQueue: planet.shipQueue.map(item => ({...item, timeLeft: item.timeLeft - 1})).filter(item => item.timeLeft >= 0),
            };
        });
        const newResearchQueue = state.researchQueue ? { ...state.researchQueue, timeLeft: state.researchQueue.timeLeft - 1 } : null;
        const newFleetMovements = state.fleetMovements.map(fleet => ({...fleet, timeLeft: fleet.timeLeft - 1})).filter(fleet => fleet.timeLeft >= 0);
        return { ...state, planets: newPlanets, researchQueue: newResearchQueue, fleetMovements: newFleetMovements };
    }
    case 'FINISH_BUILDING': {
        const { planetId, item } = action.payload;
        const newPlanets = updatePlanet(planetId, p => ({ ...p, buildings: { ...p.buildings, [item.id]: item.level } }));
        return { ...state, planets: newPlanets, notifications: [...state.notifications, { id: Date.now(), type: 'success', message: `${item.name} Lvl ${item.level} on ${newPlanets.find(p=>p.id===planetId).name} complete!` }] };
    }
    case 'FINISH_SHIP': {
        const { planetId, item } = action.payload;
        const newPlanets = updatePlanet(planetId, p => ({ ...p, ships: { ...p.ships, [item.id]: p.ships[item.id] + 1 } }));
        return { ...state, planets: newPlanets, notifications: [...state.notifications, { id: Date.now(), type: 'info', message: `A new ${item.name} constructed at ${newPlanets.find(p=>p.id===planetId).name}.` }] };
    }
    case 'FINISH_RESEARCH': {
        const finishedItem = action.payload;
        return { ...state, research: { ...state.research, [finishedItem.id]: finishedItem.level }, researchQueue: null, notifications: [...state.notifications, { id: Date.now(), type: 'success', message: `${finishedItem.name} Level ${finishedItem.level} researched!` }] };
    }
    case 'RESOLVE_COMBAT': {
        const fleet = action.payload;
        const attackerPower = Object.entries(fleet.ships).reduce((sum, [id, count]) => sum + (SHIP_DATA[id].attack * count), 0);
        const defenderPower = fleet.target.defense;
        const attackerLossRate = Math.min(1, defenderPower / (attackerPower * 2 + 1));
        const defenderLossRate = Math.min(1, attackerPower / (defenderPower * 2 + 1));
        const shipsLost = Object.fromEntries(Object.entries(fleet.ships).map(([id, count]) => [id, Math.floor(count * attackerLossRate)]));
        const shipsReturning = Object.fromEntries(Object.entries(fleet.ships).map(([id, count]) => [id, count - shipsLost[id]]));
        const newPlanets = updatePlanet(fleet.originPlanetId, p => {
            const updatedShips = { ...p.ships };
            Object.entries(shipsReturning).forEach(([id, count]) => updatedShips[id] += count);
            return { ...p, ships: updatedShips };
        });
        const report = { id: Date.now(), target: `${fleet.target.galaxy}:${fleet.target.system}`, outcome: attackerPower > defenderPower ? 'Victory' : 'Defeat', attackerLosses: shipsLost, defenderLosses: (defenderPower * defenderLossRate).toFixed(0) };
        return { ...state, planets: newPlanets, battleReports: [report, ...state.battleReports], notifications: [...state.notifications, { id: Date.now(), type: 'warning', message: `Fleet returned from ${report.target}. Outcome: ${report.outcome}`}] };
    }
    case 'FINISH_COLONIZATION': {
        const fleet = action.payload;
        const newPlanetId = state.planets.length + 1;
        const newPlanet = {
            ...initialPlanetState,
            id: newPlanetId,
            name: `Colony ${newPlanetId}`,
            coordinates: `${fleet.target.galaxy}:${fleet.target.system}`,
            resources: { metal: 500, crystal: 500, deuterium: 0 },
            buildings: { controlCenter: 1, metalMine: 0, crystalSynthesizer: 0, deuteriumRefinery: 0, shipyard: 0, researchLab: 0 },
            ships: {},
        };
        // Simulate updating galaxy map data
        GALAXY_DATA[fleet.target.galaxy - 1].systems[fleet.target.system - 1].player = 'Player1';
        return { ...state, planets: [...state.planets, newPlanet], notifications: [...state.notifications, { id: Date.now(), type: 'success', message: `New colony established at ${newPlanet.coordinates}!` }] };
    }
    case 'ADD_TO_BUILD_QUEUE': {
        const { planetId, id } = action.payload;
        const planet = state.planets.find(p => p.id === planetId);
        const level = planet.buildings[id] + 1;
        const { cost, time } = BUILDING_DATA[id];
        const item = { ...BUILDING_DATA[id], id, level, timeLeft: time(level - 1) };
        const resCost = cost(level - 1);
        const newPlanets = updatePlanet(planetId, p => ({ ...p, resources: { ...p.resources, metal: p.resources.metal - resCost.metal, crystal: p.resources.crystal - resCost.crystal }, buildQueue: [...p.buildQueue, item] }));
        return { ...state, planets: newPlanets };
    }
    case 'ADD_TO_SHIP_QUEUE': {
        const { planetId, id, amount } = action.payload;
        const ship = SHIP_DATA[id];
        const newQueueItems = Array.from({ length: amount }, () => ({ ...ship, id, timeLeft: ship.time }));
        const newPlanets = updatePlanet(planetId, p => ({ ...p, resources: { ...p.resources, metal: p.resources.metal - ship.cost.metal * amount, crystal: p.resources.crystal - ship.cost.crystal * amount }, shipQueue: [...p.shipQueue, ...newQueueItems] }));
        return { ...state, planets: newPlanets };
    }
    case 'START_RESEARCH': {
        const { id, cost, time } = action.payload;
        const level = state.research[id] + 1;
        const item = { ...RESEARCH_DATA[id], id, level, timeLeft: time(level - 1) };
        const resCost = cost(level-1);
        // Research costs are empire-wide, so we take from the current planet
        const newPlanets = updatePlanet(state.currentPlanetId, p => ({ ...p, resources: { ...p.resources, metal: p.resources.metal - (resCost.metal || 0), crystal: p.resources.crystal - (resCost.crystal || 0), deuterium: p.resources.deuterium - (resCost.deuterium || 0) }}));
        return { ...state, planets: newPlanets, researchQueue: item };
    }
    case 'LAUNCH_FLEET': {
        const { originPlanetId, ships, target, mission } = action.payload;
        const newFleet = { id: Date.now(), originPlanetId, ships, target, mission, timeLeft: 300 }; // Simplified travel time
        const newPlanets = updatePlanet(originPlanetId, p => {
            const newShips = { ...p.ships };
            Object.entries(ships).forEach(([id, count]) => newShips[id] -= count);
            return { ...p, ships: newShips };
        });
        return { ...state, planets: newPlanets, fleetMovements: [...state.fleetMovements, newFleet] };
    }
    case 'CREATE_ALLIANCE': return { ...state, alliance: { name: action.payload, members: ['You'] } };
    case 'REMOVE_NOTIFICATION': return { ...state, notifications: state.notifications.filter(n => n.id !== action.payload) };
    default: return state;
  }
}

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
// UI COMPONENTS
//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~

const ResourceBar = ({ resources, darkMatter, planets, currentPlanetId, setCurrentPlanetId }) => (
  <div className="fixed top-0 left-0 right-0 bg-black bg-opacity-50 backdrop-blur-sm p-2 z-50 text-white text-xs md:text-sm">
    <div className="flex justify-around items-center">
        <div className="flex items-center space-x-1"><span>üî©</span><span>Metal: {formatNumber(resources.metal)}</span></div>
        <div className="flex items-center space-x-1"><span>üíé</span><span>Crystal: {formatNumber(resources.crystal)}</span></div>
        <div className="flex items-center space-x-1"><span>üíß</span><span>Deuterium: {formatNumber(resources.deuterium)}</span></div>
        <div className="flex items-center space-x-1"><span>‚ú®</span><span>Dark Matter: {formatNumber(darkMatter)}</span></div>
    </div>
    {planets.length > 1 && (
        <div className="flex justify-center items-center mt-2 space-x-2">
            {planets.map(p => (
                <button key={p.id} onClick={() => setCurrentPlanetId(p.id)} className={`btn btn-xs ${p.id === currentPlanetId ? 'btn-primary' : 'btn-ghost'}`}>{p.name} [{p.coordinates}]</button>
            ))}
        </div>
    )}
  </div>
);

const BottomNav = ({ activeView, setActiveView }) => {
  const navItems = ['Planet', 'Galaxy', 'Fleet', 'Research', 'Alliance'];
  return (
    <div className="fixed bottom-0 left-0 right-0 bg-black bg-opacity-70 backdrop-blur-md z-50 flex justify-around p-1">
      {navItems.map(item => (
        <button key={item} onClick={() => setActiveView(item)} className={`btn btn-ghost btn-sm md:btn-md flex-col h-16 transition-all duration-300 ${activeView === item ? 'text-cyan-400 scale-110' : 'text-gray-400'}`}>
          <span className="text-2xl">{item === 'Planet' ? 'üåç' : item === 'Galaxy' ? 'üåå' : item === 'Fleet' ? 'üöÄ' : item === 'Research' ? 'üî¨' : 'ü§ù'}</span>
          <span className="text-xs">{item}</span>
        </button>
      ))}
    </div>
  );
};

const PlanetView = ({ planet, dispatch }) => {
  const [selectedBuilding, setSelectedBuilding] = useState(null);

  const handleUpgrade = (id) => {
    dispatch({ type: 'ADD_TO_BUILD_QUEUE', payload: { planetId: planet.id, id } });
    setSelectedBuilding(null);
  };

  const BuildingModal = ({ buildingId, onClose }) => {
    const building = BUILDING_DATA[buildingId];
    const currentLevel = planet.buildings[buildingId];
    const nextLevel = currentLevel + 1;
    const upgradeCost = building.cost(currentLevel);
    const upgradeTime = building.time(currentLevel);
    
    const canAfford = planet.resources.metal >= upgradeCost.metal && planet.resources.crystal >= upgradeCost.crystal;
    const requirements = building.requires;
    const reqsMet = !requirements || planet.buildings[requirements.building] >= requirements.level;
    const isQueueFull = planet.buildQueue.length >= 5;
    const canUpgrade = canAfford && reqsMet && !isQueueFull;

    return (
        <div className="modal modal-open">
            <div className="modal-box bg-gray-900 border border-cyan-700 shadow-cyan-500/50 shadow-lg">
                <h3 className="font-bold text-lg">{building.name} (Lvl {currentLevel})</h3>
                <p className="py-2 text-sm text-gray-400">{building.description}</p>
                
                <div className="divider my-2">Info/Upgrade</div>

                <div className="space-y-3 text-sm">
                    <h4 className="font-bold text-cyan-400">Upgrade to Level {nextLevel}</h4>
                    <p className="text-green-400"><strong>Benefit:</strong> {building.benefit(currentLevel)}</p>
                    
                    <h4 className="font-bold mt-2">Requirements:</h4>
                    <p>Time: {formatTime(upgradeTime)}</p>
                    <p className={planet.resources.metal >= upgradeCost.metal ? '' : 'text-red-400'}>
                        üî© Metal: {formatNumber(upgradeCost.metal)}
                    </p>
                    <p className={planet.resources.crystal >= upgradeCost.crystal ? '' : 'text-red-400'}>
                        üíé Crystal: {formatNumber(upgradeCost.crystal)}
                    </p>
                    {requirements && (
                        <p className={reqsMet ? '' : 'text-red-400'}>
                            Requires: {BUILDING_DATA[requirements.building].name} Level {requirements.level}
                        </p>
                    )}
                </div>

                <div className="modal-action mt-6">
                     <div data-tip={!canUpgrade ? (isQueueFull ? "Build queue is full" : !reqsMet ? "Requirements not met" : "Not enough resources") : "Start Upgrade"} className="tooltip">
                        <button className="btn btn-primary" disabled={!canUpgrade} onClick={() => handleUpgrade(buildingId)}>Upgrade</button>
                    </div>
                    <button className="btn" onClick={onClose}>Close</button>
                </div>
            </div>
        </div>
    );
  };

  return (
    <div className="p-4 pt-24 pb-24 text-white">
      <h1 className="text-3xl font-bold text-center mb-4 text-cyan-300">{planet.name} [{planet.coordinates}]</h1>
      <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
        {Object.entries(BUILDING_DATA).map(([id, data]) => {
          const level = planet.buildings[id] || 0;
          const isBuilding = planet.buildQueue.some(item => item.id === id);
          const requirementsMet = !data.requires || planet.buildings[data.requires.building] >= data.requires.level;
          const canSelect = level > 0 || (level === 0 && requirementsMet);
          return (
            <div key={id} className={`card bg-gray-800 shadow-xl image-full ${canSelect ? 'opacity-100 cursor-pointer' : 'opacity-40'}`} onClick={() => canSelect && setSelectedBuilding(id)}>
              <figure><img src={`https://placehold.co/400x300/000000/333333?text=${data.name.replace(' ', '+')}`} alt={data.name} className="opacity-30" /></figure>
              <div className="card-body justify-between"><h2 className="card-title">{data.name}</h2><p>Level: {level}</p>{isBuilding && <span className="loading loading-spinner loading-xs text-cyan-400"></span>}</div>
            </div>
          );
        })}
      </div>
      {selectedBuilding && <BuildingModal buildingId={selectedBuilding} onClose={() => setSelectedBuilding(null)} />}
    </div>
  );
};

const GalaxyView = ({ dispatch, planets, currentPlanetId }) => {
  const [galaxy, setGalaxy] = useState(1);
  const [system, setSystem] = useState(1);
  const [target, setTarget] = useState(null);
  const [fleetToSend, setFleetToSend] = useState({});
  const [missionType, setMissionType] = useState('attack');
  const currentPlanet = planets.find(p => p.id === currentPlanetId);

  const handleLaunch = () => {
    const finalFleet = missionType === 'colonize' ? { colonyShip: 1 } : fleetToSend;
    dispatch({ type: 'LAUNCH_FLEET', payload: { originPlanetId: currentPlanet.id, ships: finalFleet, target, mission: missionType } });
    setTarget(null); setFleetToSend({});
  };
  
  return (
    <div className="p-4 pt-24 pb-24 text-white">
      <h1 className="text-3xl font-bold text-center mb-4 text-cyan-300">Galaxy Map</h1>
      <div className="bg-gray-800 p-2 rounded-lg mb-4 flex justify-between items-center"><div className="flex items-center space-x-2"><button className="btn btn-xs btn-primary" onClick={() => setGalaxy(g => Math.max(1, g - 1))}>&lt;</button><span>Galaxy: {galaxy}</span><button className="btn btn-xs btn-primary" onClick={() => setGalaxy(g => Math.min(9, g + 1))}>&gt;</button></div><div className="flex items-center space-x-2"><button className="btn btn-xs btn-primary" onClick={() => setSystem(s => Math.max(1, s - 1))}>&lt;</button><span>System: {system}</span><button className="btn btn-xs btn-primary" onClick={() => setSystem(s => Math.min(499, s + 1))}>&gt;</button></div></div>
      <div className="bg-black bg-opacity-50 rounded-lg p-4 h-[60vh] overflow-y-auto">
        <ul className="space-y-2">
          {GALAXY_DATA[galaxy - 1].systems.slice(system - 1, system + 14).map((sys, index) => (
            <li key={index} className="flex justify-between items-center p-2 rounded hover:bg-gray-700">
              <div className="flex items-center space-x-4"><span>ü™ê</span><div><p className="font-bold">{galaxy}:{sys.id}</p>{sys.player ? <p className="text-sm text-cyan-400">{sys.player} ({sys.planets} planets)</p> : <p className="text-sm text-gray-400">(Unoccupied)</p>}</div></div>
              <div className="flex space-x-2">
                {sys.player && sys.player !== "Player1" && <button className="btn btn-xs btn-error" onClick={() => {setTarget({...sys, galaxy, system: sys.id}); setMissionType('attack');}}>Attack</button>}
                {!sys.player && currentPlanet.ships.colonyShip > 0 && <button className="btn btn-xs btn-success" onClick={() => {setTarget({...sys, galaxy, system: sys.id}); setMissionType('colonize');}}>Colonize</button>}
              </div>
            </li>
          ))}
        </ul>
      </div>
      {target && (
        <div className="modal modal-open">
            <div className="modal-box bg-gray-900 border border-cyan-500">
                <h3 className="font-bold text-lg">{missionType === 'attack' ? `Attack ${target.player}` : `Colonize`} at {target.galaxy}:{target.system}</h3>
                <div className="py-4 space-y-2">
                    {missionType === 'attack' && Object.entries(currentPlanet.ships).filter(([_, count]) => count > 0).map(([id, count]) => (
                        <div key={id} className="form-control"><label className="label"><span className="label-text text-white">{SHIP_DATA[id].name} (Available: {count})</span></label><input type="number" max={count} min="0" defaultValue="0" onChange={(e) => setFleetToSend({...fleetToSend, [id]: parseInt(e.target.value)})} className="input input-bordered w-full bg-gray-700" /></div>
                    ))}
                    {missionType === 'colonize' && <p>This will consume one Colony Ship.</p>}
                </div>
                <div className="modal-action"><button className={`btn ${missionType === 'attack' ? 'btn-error' : 'btn-success'}`} onClick={handleLaunch}>Launch</button><button className="btn" onClick={() => setTarget(null)}>Cancel</button></div>
            </div>
        </div>
      )}
    </div>
  );
};

const FleetView = ({ planet, dispatch, research }) => {
    const [selectedShip, setSelectedShip] = useState(null);
    const [buildAmount, setBuildAmount] = useState(1);
    const handleBuild = () => {
        const ship = SHIP_DATA[selectedShip];
        const canAfford = planet.resources.metal >= ship.cost.metal * buildAmount && planet.resources.crystal >= ship.cost.crystal * buildAmount;
        if(canAfford) {
            dispatch({ type: 'ADD_TO_SHIP_QUEUE', payload: { planetId: planet.id, id: selectedShip, amount: buildAmount } });
        } else { alert("Not enough resources."); }
        setSelectedShip(null); setBuildAmount(1);
    };
    return (
        <div className="p-4 pt-24 pb-24 text-white">
            <h1 className="text-3xl font-bold text-center mb-4 text-cyan-300">Shipyard at {planet.name}</h1>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                {Object.entries(SHIP_DATA).map(([id, data]) => {
                    const requirementsMet = research[data.requires.research] >= data.requires.level;
                    return (
                        <div key={id} className={`card bg-gray-800 shadow-xl ${requirementsMet ? 'opacity-100 cursor-pointer' : 'opacity-40'}`} onClick={() => requirementsMet && setSelectedShip(id)}>
                            <figure><img src={`https://placehold.co/400x300/111827/555555?text=${data.name.replace(' ', '+')}`} alt={data.name} className="opacity-50" /></figure>
                            <div className="card-body"><h2 className="card-title">{data.name}</h2><p>Owned: {planet.ships[id] || 0}</p></div>
                        </div>
                    );
                })}
            </div>
            {selectedShip && (
                <div className="modal modal-open">
                    <div className="modal-box bg-gray-900 border border-cyan-500">
                        <h3 className="font-bold text-lg">Build {SHIP_DATA[selectedShip].name}</h3><p className="py-2">Attack: {SHIP_DATA[selectedShip].attack} | Defense: {SHIP_DATA[selectedShip].defense}</p>
                        <div className="my-2"><p>Cost (per unit): üî© {formatNumber(SHIP_DATA[selectedShip].cost.metal)} üíé {formatNumber(SHIP_DATA[selectedShip].cost.crystal)}</p><p>Time: {formatTime(SHIP_DATA[selectedShip].time)}</p></div>
                        <div className="form-control"><label className="label"><span className="label-text text-white">Amount</span></label><input type="number" value={buildAmount} onChange={(e) => setBuildAmount(parseInt(e.target.value))} min="1" max="100" className="input input-bordered w-full bg-gray-700" /></div>
                        <div className="modal-action"><button className="btn btn-primary" onClick={handleBuild}>Build {buildAmount}</button><button className="btn" onClick={() => setSelectedShip(null)}>Close</button></div>
                    </div>
                </div>
            )}
        </div>
    );
};

const ResearchView = ({ research, researchQueue, dispatch, planets, currentPlanetId }) => {
    const currentPlanet = planets.find(p => p.id === currentPlanetId);
    const handleResearch = (id) => {
        const level = research[id];
        const { cost, time } = RESEARCH_DATA[id];
        const resCost = cost(level);
        const canAfford = currentPlanet.resources.metal >= (resCost.metal || 0) && currentPlanet.resources.crystal >= (resCost.crystal || 0) && currentPlanet.resources.deuterium >= (resCost.deuterium || 0);
        if (canAfford && !researchQueue) {
            dispatch({ type: 'START_RESEARCH', payload: { id, cost, time } });
        } else { alert("Cannot afford or research is in progress."); }
    };
    return (
        <div className="p-4 pt-24 pb-24 text-white">
            <h1 className="text-3xl font-bold text-center mb-4 text-cyan-300">Research Lab</h1>
            <div className="space-y-4">
                {Object.entries(RESEARCH_DATA).map(([id, data]) => {
                    const level = research[id];
                    const reqBuildingMet = planets.some(p => p.buildings[data.requires.building] >= data.requires.level);
                    const reqResearchMet = !data.requires.research || research[data.requires.research] >= data.requires.level;
                    const canResearch = reqBuildingMet && reqResearchMet;
                    return (
                        <div key={id} className={`card card-side bg-gray-800 shadow-xl ${canResearch ? '' : 'opacity-50'}`}>
                            <div className="card-body"><h2 className="card-title">{data.name} (Level {level})</h2><p>{data.description}</p><p className="text-xs">Requires: {data.requires.building ? `${BUILDING_DATA[data.requires.building].name} Lvl ${data.requires.level}` : ''} {data.requires.research ? `${RESEARCH_DATA[data.requires.research].name} Lvl ${data.requires.level}` : ''}</p><div className="card-actions justify-end"><button className="btn btn-primary" disabled={!canResearch || researchQueue} onClick={() => handleResearch(id)}>Research Lvl {level + 1}</button></div></div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
};

const AllianceView = ({ alliance, dispatch }) => {
    const [allianceName, setAllianceName] = useState('');
    if (alliance) {
        return (<div className="p-4 pt-24 pb-24 text-white text-center"><h1 className="text-3xl font-bold mb-4 text-cyan-300">{alliance.name}</h1><h2 className="text-xl font-semibold mb-2">Members</h2><ul className="list-disc list-inside bg-gray-800 p-4 rounded-lg">{alliance.members.map(m => <li key={m}>{m}</li>)}</ul></div>);
    }
    return (<div className="p-4 pt-24 pb-24 text-white text-center"><h1 className="text-3xl font-bold mb-4 text-cyan-300">Join an Alliance</h1><p className="mb-4">You are not currently in an alliance.</p><div className="form-control w-full max-w-xs mx-auto"><input type="text" placeholder="Enter Alliance Name" className="input input-bordered w-full bg-gray-700" value={allianceName} onChange={(e) => setAllianceName(e.target.value)} /><button className="btn btn-primary mt-2" onClick={() => dispatch({type: 'CREATE_ALLIANCE', payload: allianceName})}>Create Alliance</button></div></div>);
};

const QueueDisplay = ({ planets, currentPlanetId, researchQueue, fleetMovements }) => {
    const currentPlanet = planets.find(p => p.id === currentPlanetId);
    if (!currentPlanet) return null;
    return (
    <div className="fixed top-24 right-2 w-64 bg-black bg-opacity-70 backdrop-blur-md p-2 rounded-lg z-40 text-white text-sm">
        <h3 className="font-bold border-b border-cyan-500 pb-1 mb-2">Activity</h3>
        <div className="max-h-64 overflow-y-auto">
            {currentPlanet.buildQueue.length === 0 && currentPlanet.shipQueue.length === 0 && !researchQueue && fleetMovements.length === 0 && <p className="text-gray-400 text-xs">No active queues.</p>}
            {researchQueue && <div className="flex justify-between items-center text-xs text-yellow-300"><span>{researchQueue.name} (Lvl {researchQueue.level})</span><span>{formatTime(researchQueue.timeLeft)}</span></div>}
            {currentPlanet.buildQueue.map((item, index) => (<div key={`b-${index}`} className="flex justify-between items-center text-xs"><span>{item.name} (Lvl {item.level})</span><span>{formatTime(item.timeLeft)}</span></div>))}
            {currentPlanet.shipQueue.map((item, index) => (<div key={`s-${index}`} className="flex justify-between items-center text-xs"><span>{item.name}</span><span>{formatTime(item.timeLeft)}</span></div>))}
            {fleetMovements.map((item) => (<div key={item.id} className="flex justify-between items-center text-xs text-red-400"><span>{item.mission} to {item.target.galaxy}:{item.target.system}</span><span>{formatTime(item.timeLeft)}</span></div>))}
        </div>
    </div>
)};

const NotificationHandler = ({ notifications, dispatch }) => (
    <div className="toast toast-top toast-center z-[100]">
        {notifications.map(note => (
            <div key={note.id} className={`alert alert-${note.type} bg-opacity-80`}><span>{note.message}</span><button className="btn btn-xs btn-ghost" onClick={() => dispatch({type: 'REMOVE_NOTIFICATION', payload: note.id})}>X</button></div>
        ))}
    </div>
);

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
// MAIN APP COMPONENT
//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~

export default function App() {
  const [gameState, dispatch] = useReducer(gameReducer, initialState);
  const [activeView, setActiveView] = useState('Planet');

  const setCurrentPlanetId = (id) => dispatch({ type: 'SET_CURRENT_PLANET', payload: id });
  const currentPlanet = gameState.planets.find(p => p.id === gameState.currentPlanetId);

  useEffect(() => { const gameTick = setInterval(() => { dispatch({ type: 'TICK' }); }, 1000); return () => clearInterval(gameTick); }, []);
  
  useEffect(() => {
    gameState.planets.forEach(planet => {
        if (planet.buildQueue.length > 0 && planet.buildQueue[0].timeLeft <= 0) { dispatch({ type: 'FINISH_BUILDING', payload: { planetId: planet.id, item: planet.buildQueue[0] } }); }
        if (planet.shipQueue.length > 0 && planet.shipQueue[0].timeLeft <= 0) { dispatch({ type: 'FINISH_SHIP', payload: { planetId: planet.id, item: planet.shipQueue[0] } }); }
    });
    if (gameState.researchQueue && gameState.researchQueue.timeLeft <= 0) { dispatch({ type: 'FINISH_RESEARCH', payload: gameState.researchQueue }); }
    if (gameState.fleetMovements.length > 0 && gameState.fleetMovements[0].timeLeft <=0) {
        const fleet = gameState.fleetMovements[0];
        if (fleet.mission === 'attack') {
            dispatch({ type: 'RESOLVE_COMBAT', payload: fleet });
        } else if (fleet.mission === 'colonize') {
            dispatch({ type: 'FINISH_COLONIZATION', payload: fleet });
        }
    }
  }, [gameState.planets, gameState.researchQueue, gameState.fleetMovements]);

  const renderView = () => {
    if (!currentPlanet) return <div>Loading...</div>;
    switch (activeView) {
      case 'Planet': return <PlanetView planet={currentPlanet} dispatch={dispatch} />;
      case 'Galaxy': return <GalaxyView dispatch={dispatch} planets={gameState.planets} currentPlanetId={gameState.currentPlanetId} />;
      case 'Fleet': return <FleetView planet={currentPlanet} dispatch={dispatch} research={gameState.research} />;
      case 'Research': return <ResearchView research={gameState.research} researchQueue={gameState.researchQueue} dispatch={dispatch} planets={gameState.planets} currentPlanetId={gameState.currentPlanetId} />;
      case 'Alliance': return <AllianceView alliance={gameState.alliance} dispatch={dispatch} />;
      default: return <PlanetView planet={currentPlanet} dispatch={dispatch} />;
    }
  };

  return (
    <div data-theme="cyberpunk" className="bg-gray-900 min-h-screen bg-cover bg-center bg-fixed" style={{backgroundImage: "url('https://images.pexels.com/photos/956999/milky-way-starry-sky-night-sky-star-956999.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2')"}}>
      {currentPlanet && <ResourceBar resources={currentPlanet.resources} darkMatter={gameState.darkMatter} planets={gameState.planets} currentPlanetId={gameState.currentPlanetId} setCurrentPlanetId={setCurrentPlanetId} />}
      <main>{renderView()}</main>
      <QueueDisplay planets={gameState.planets} currentPlanetId={gameState.currentPlanetId} researchQueue={gameState.researchQueue} fleetMovements={gameState.fleetMovements} />
      <NotificationHandler notifications={gameState.notifications} dispatch={dispatch} />
      <BottomNav activeView={activeView} setActiveView={setActiveView} />
    </div>
  );
}
